<!-- GROUPS + SEANCE + PLANNING (final) -->
<a class="w-schedule-modal__figure height-25% width-30%@md height-100%@md" href="#0">
  <img src="./img/edit-image.png" alt="Connexion image" />
</a>

<div class="w-schedule-modal__body padding-md width-70%@md height-75%">
  <div class="container max-width-xs padding-y-lg">
    <!-- Liste des groupes (target element : allGroups ou fallback groupTags) -->
    <div id="allGroups" class="margin-bottom-sm"></div>
    <div id="groupTags" class="margin-bottom-sm" style="display:none;">
      <p class="form-label">Groupes actuels :</p>
    </div>
  </div>
</div>

<script>
(async () => {
  const allGroupsEl = document.getElementById('allGroups');

  // --- helpers ---
  async function apiGET(url) {
    const r = await fetch(url);
    if (!r.ok) throw new Error(`${url} -> ${r.status}`);
    return r.json();
  }
  async function apiPOST(url, body) {
    return fetch(url, { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
  }
  async function apiDELETE(url) {
    return fetch(url, { method: 'DELETE' });
  }

  let allGroups = [];
  let myGroups = [];

  async function refreshAll() {
    allGroups = await apiGET('/api/groups');
    myGroups = await apiGET('/api/eleve/groups').catch(()=>[]);

    allGroupsEl.innerHTML = '';
    allGroups.forEach(g => {
      let inIt = myGroups.some(m => m.id === g.id);
      const wrap = document.createElement('div');
      wrap.style.display = 'flex';
      wrap.style.gap = '8px';
      wrap.style.alignItems = 'center';
      wrap.style.marginBottom = '6px';

      const name = document.createElement('div');
      name.textContent = g.nom;
      wrap.appendChild(name);

      const btn = document.createElement('button');
      btn.className = inIt ? 'btn btn--subtle' : 'btn btn--primary';
      btn.textContent = inIt ? 'Quit' : 'Join';

      btn.addEventListener('click', async () => {
        try {
          if (inIt) {
            await apiDELETE(`/api/eleve/groups/${g.id}`);
            myGroups = myGroups.filter(m => m.id !== g.id);
          } else {
            await apiPOST('/api/eleve/groups', { nom: g.nom });
            myGroups.push(g);
          }
          await refreshAll(); // re-render list
        } catch(e) {
          alert('‚ùå Erreur: ' + e.message);
        }
      });

      wrap.appendChild(btn);
      allGroupsEl.appendChild(wrap);
    });
  }

  await refreshAll();
})();
</script>
