<!doctype html>
<html lang="en" data-theme="dark">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="./css/reset.css">
  <link rel="stylesheet" href="./css/typography.css">
  <link id="cd-base-part-1" rel="stylesheet" href="./css/icons.css">
  <link rel="stylesheet" href="./css/forms.css">
  <link rel="stylesheet" href="./css/header.css">

  <!-- Component CSS -->
  <link id="codyframe" rel="stylesheet" href="./css/weekly-schedule.css">
  <!-- End Component CSS -->
  <link id="cd-cdf-util" rel="stylesheet" href="./css/util.css?v=1">
  <style>
    .height-25\% {
      height: 25%;
    }

    @media (min-width: 64rem) {
      .width-30\%\@md {
        width: 30%;
      }

      .width-70\%\@md {
        width: 70%;
      }

      .height-100\%\@md {
        height: 100%;
      }
    }
  </style>
  <script>
    document.documentElement.style.setProperty('--w-schedule-row-height', `${window.innerHeight / 14}px`);
  </script>
</head>

<body>
  <header class="header position-relative js-header ">
  <div class="header__container container max-width-lg">
    <div class="header__logo">
      <a href="#0">
        <svg width="104" height="30" viewBox="0 0 104 30"><title>Go to homepage</title><path d="M37.54 24.08V3.72h4.92v16.37h8.47v4zM60.47 24.37a7.82 7.82 0 01-5.73-2.25 8.36 8.36 0 01-2-5.62 8.32 8.32 0 012.08-5.71 8 8 0 015.64-2.18 8.07 8.07 0 015.68 2.2 8.49 8.49 0 012 5.69 8.63 8.63 0 01-1.78 5.38 7.6 7.6 0 01-5.89 2.49zm0-3.67c2.42 0 2.73-3 2.73-4.23s-.31-4.26-2.73-4.26-2.79 3-2.79 4.26.32 4.23 2.82 4.23zM95.49 24.37a7.82 7.82 0 01-5.73-2.25 8.36 8.36 0 01-2-5.62 8.32 8.32 0 012.08-5.71 8.4 8.4 0 0111.31 0 8.43 8.43 0 012 5.69 8.6 8.6 0 01-1.77 5.38 7.6 7.6 0 01-5.89 2.51zm0-3.67c2.42 0 2.73-3 2.73-4.23s-.31-4.26-2.73-4.26-2.8 3-2.8 4.26.31 4.23 2.83 4.23zM77.66 30c-5.74 0-7-3.25-7.23-4.52l4.6-.26c.41.91 1.17 1.41 2.76 1.41a2.45 2.45 0 002.82-2.53v-2.68a7 7 0 01-1.7 1.75 6.12 6.12 0 01-5.85-.08c-2.41-1.37-3-4.25-3-6.66 0-.89.12-3.67 1.45-5.42a5.67 5.67 0 014.64-2.4c1.2 0 3 .25 4.46 2.82V8.81h4.85v15.33a5.2 5.2 0 01-2.12 4.32A9.92 9.92 0 0177.66 30zm.15-9.66c2.53 0 2.81-2.69 2.81-3.91s-.31-4-2.81-4-2.81 2.8-2.81 4 .27 3.91 2.81 3.91zM55.56 3.72h9.81v2.41h-9.81z" fill="var(--color-contrast-higher)"/><circle cx="15" cy="15" r="15" fill="var(--color-primary)"/></svg>
      </a>
    </div>

    <button class="btn btn--subtle header__trigger js-header__trigger" aria-label="Toggle menu" aria-expanded="false" aria-controls="header-nav">
      <i class="header__trigger-icon" aria-hidden="true"></i>
    </button>

    <nav class="header__nav js-header__nav" id="header-nav" role="navigation" aria-label="Main">
      <div class="header__nav-inner">
        <div class="header__label">Main menu</div>
        <ul class="header__list">
          <li class="header__item"><a href="#0" class="header__link">Param√®tre </a></li>
          <li class="header__item"><a href="#0" class="header__link">√âdition</a></li>
          <li class="header__item header__item--divider" aria-hidden="true"></li>
          <li class="header__item"><a href="#0" class="header__link">Se D√©connecter</a></li>
        </ul>
      </div>
    </nav>
  </div>
</header>
  <div class="container max-width-xl padding-y-sm js-cd-demo">
    <!-- Component HTML -->
    <div class="w-schedule js-tabs js-w-schedule tabs--no-interaction swiper" data-hide-panel-class="display@md"
      data-w-schedule-timeline="08:00-19:00" style="overflow: hidden; ">
      <!-- üëá events -->
      <div class="w-schedule__days js-tabs__panels swiper-wrapper" , style="width: fit-content;">
        <!-- dynamically generated -->
      </div><!-- background rows -->
      <div class="w-schedule__grid js-w-schedule__grid" aria-hidden="true">
        <!-- dynamically generated -->
      </div>
    </div><!-- modal window (weekly schedule) -->
    <div id="w-schedule-modal-id"
      class="w-schedule-modal modal modal--animate-fade bg-black bg-opacity-90% js-w-schedule-modal js-modal">
      <div
        class="w-schedule-modal__content modal__content bg radius-md inner-glow shadow-md opacity-0 flex@md js-w-schedule-modal__content"
        role="alertdialog" aria-label="Event Info"><!-- modal content is dynamically loaded -->
        <div class="ske height-25% width-30%@md height-100%@md" aria-hidden="true"></div>
        <div class="padding-md width-70%@md height-100%@md" aria-hidden="true">
          <ul class="grid gap-xs">
            <li class="col-3 padding-bottom-sm">
              <div class="ske ske--text text-xl"></div>
            </li>
            <li>
              <div class="ske ske--text"></div>
            </li>
            <li>
              <div class="ske ske--text"></div>
            </li>
            <li class="col-6">
              <div class="ske ske--text"></div>
            </li>
          </ul>
        </div><!-- [end] modal content -->
      </div>
    </div><!-- modal content clone - used for morphing bg -->
    <div class="w-schedule-morph-bg bg radius-md hide js-w-schedule-morph-bg" aria-hidden="true"></div><button
      class="w-schedule-close-btn js-w-schedule-close-btn"><svg class="icon icon--sm" viewBox="0 0 24 24">
        <title>Close modal window</title>
        <g fill="none" stroke="currentColor" stroke-miterlimit="10" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round">
          <line x1="3" y1="3" x2="21" y2="21"></line>
          <line x1="21" y1="3" x2="3" y2="21"></line>
        </g>
      </svg></button>
      <!-- [end] modal window (weekly schedule) -->
      
      <!-- End Component HTML -->
  </div>
  <!-- Component JS -->
  <script src="./js/weekly-schedule.min.js"></script>
  <script src="./js/header.js"></script>
  <!-- Swiper JS -->
  <script src="./js/swiper-bundle.min.js"></script>
  <script src="./js/populate.js"></script>

  <!-- End Component JS -->

  <script>

    var wSchedule = document.getElementsByClassName('js-w-schedule')[0];

    var searchValues = [
      { id: 1, content: '<a class="w-schedule-modal__figure height-25% width-30%@md height-100%@md" href="#0"><img src="./img/weekly-schedule-img-1.jpg" alt="Image description"></a><div class="w-schedule-modal__body padding-md width-70%@md height-100%@md"><div class="text-component"><h1 class="text-xl">Abs Circuit</h1><p class="color-contrast-medium">Lorem ipsum dolor sit amet consectetur adipisicing elit. Aspernatur et labore esse mollitia. Pariatur error nesciunt ab illum.</p><p class="color-contrast-medium">Lorem ipsum dolor sit amet consectetur adipisicing elit. Dicta placeat ex sunt?</p><p><button class="btn btn--primary">Book Class</button></p></div></div>' },
      { id: 2, content: '<a class="w-schedule-modal__figure height-25% width-30%@md height-100%@md" href="#0"><img src="./img/weekly-schedule-img-maths.png" alt="Image description"></a><div class="w-schedule-modal__body padding-md width-70%@md height-100%@md"><div class="text-component"><h1 class="text-xl">Rowing Workout</h1><p class="color-contrast-medium">Lorem ipsum dolor sit amet consectetur adipisicing elit. Aspernatur et labore esse mollitia. Pariatur error nesciunt ab illum.</p><p class="color-contrast-medium">Lorem ipsum dolor sit amet consectetur adipisicing elit. Dicta placeat ex sunt?</p><p><button class="btn btn--primary">Book Class</button></p></div></div>' },
      { id: 3, content: '<a class="w-schedule-modal__figure height-25% width-30%@md height-100%@md" href="#0"><img src="./img/weekly-schedule-img-3.jpg" alt="Image description"></a><div class="w-schedule-modal__body padding-md width-70%@md height-100%@md"><div class="text-component"><h1 class="text-xl">Yoga Level 1</h1><p class="color-contrast-medium">Lorem ipsum dolor sit amet consectetur adipisicing elit. Aspernatur et labore esse mollitia. Pariatur error nesciunt ab illum.</p><p class="color-contrast-medium">Lorem ipsum dolor sit amet consectetur adipisicing elit. Dicta placeat ex sunt?</p><p><button class="btn btn--primary">Book Class</button></p></div></div>' },
      { id: 4, content: '<a class="w-schedule-modal__figure height-25% width-30%@md height-100%@md" href="#0"><img src="./img/weekly-schedule-img-4.jpg" alt="Image description"></a><div class="w-schedule-modal__body padding-md width-70%@md height-100%@md"><div class="text-component"><h1 class="text-xl">Restorative Yoga</h1><p class="color-contrast-medium">Lorem ipsum dolor sit amet consectetur adipisicing elit. Aspernatur et labore esse mollitia. Pariatur error nesciunt ab illum.</p><p class="color-contrast-medium">Lorem ipsum dolor sit amet consectetur adipisicing elit. Dicta placeat ex sunt?</p><p><button class="btn btn--primary">Book Class</button></p></div></div>' }
    ];
    let my_schedule = new WSchedule({
      element: wSchedule,
      searchData: function (trigger, cb) {
        if (trigger.isFakeTrigger) {
          return setTimeout(function () {
            cb(trigger.getModalContent());
          }, 500);
        }
        var event = trigger.getAttribute('data-w-schedule-event') || 1;
        var data = searchValues.filter(function (item) {
          return item['id'] == event;
        });
        // wait to load the image
        loadImage(event, function () {
          setTimeout(function () {
            cb(data[0]['content']);
          }, 1000);
        });
      }
    });

    function loadImage(id, cb) {
      var src = './img/weekly-schedule-img-1.jpg';//'./img/weekly-schedule-img-' + id + '.jpg';
      var image = new Image();
      var loaded = false;
      image.onload = function () {
        if (loaded) return;
        cb();
      }
      image.src = src;
      if (image.complete) {
        loaded = true;
        cb();
      }
    };


    function showCustomModal(content) {
      e = my_schedule.modal[0]
      // Cr√©e un fake trigger
      const mockTrigger = {
        closest(selector) {
          return {
            getBoundingClientRect() {
              return { top: 100, left: 100, width: 200, height: 100, right: 300, bottom: 200 };
            },
            getAttribute(attr) {
              return null;
            },
            getModalContent() {
              return content;
            },
            isFakeTrigger: true
          }
        },
        focus() {
          return null;
        }
      };

      e.dispatchEvent(new CustomEvent("openModal", { detail: mockTrigger }));
    }

    async function loadModalFromURL(url) {
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`Erreur HTTP ${res.status}`);

        const html = await res.text();

        showCustomModal(html);
      } catch (err) {
        console.error('Erreur chargement modal HTML:', err);
        alert('Erreur chargement contenu');
      }
    }
  </script>

  <!-- Initialize Swiper -->
  <script>
    const container = document.querySelector('.swiper .swiper-wrapper');

    // Utilitaire circulaire
    function getDay(index) {
      const day_id = index % 7;
      const week_id = (index - day_id)/7;
      console.log(`week : ${week_id}`)
      return {
      id: `${index}`, name: "Lundi", events: [
        { id: 1, name: "Abs Circuit", datetime: "09:30PT1H" },
        { id: 2, name: "Rowing Workout", datetime: "11:00PT1H30M" },
        { id: 3, name: "Yoga Level 1", datetime: "14:00PT1H15M" }
      ]
    };
    }

    function renderSlide(index) {
      return generateScheduleDay(getDay(index)).outerHTML;
    }

    // Index logique du centre
    let currentIndex = 0;

    // D√©tecte combien de slides sont visibles en fonction de l‚Äô√©cran
    function getVisibleCount() {
      return window.innerWidth >= 1024 ? 7 : 1;
    }

    // Met √† jour les slides visibles autour du centre
    function updateSlides(centerIndex) {
      const visible = getVisibleCount();
      container.innerHTML = '';
      for (let i = 1; i <= 3*visible; i++) {
        container.insertAdjacentHTML('beforeend', renderSlide(centerIndex + i));
      }
      my_schedule.update(); // ta fonction custom
    }

    // Initial setup
    updateSlides(currentIndex);

    // Instancie Swiper
    const swiper = new Swiper('.swiper', {
      initialSlide: getVisibleCount(),
      allowTouchMove: true,
      observeParents: true,
      slidesPerView: getVisibleCount(),
      slidesPerGroup: getVisibleCount(),
      spaceBetween: 10,
      breakpoints: {
        1024: {
          slidesPerView: 7,
          slidesPerGroup: 7,
          spaceBetween: 0
        }
      },
      on: {
        slideChangeTransitionEnd: function () {
          const visible = getVisibleCount();

          const realIndex = this.activeIndex;

          if (realIndex > visible) {
            currentIndex += visible;
          } else if (realIndex < visible) {
            currentIndex -= visible;
          }

          updateSlides(currentIndex);
          this.update();
          this.slideTo(visible, 0);
        }
      }
    });

    // Facultatif : reload si on change de taille d'√©cran de fa√ßon significative
    window.addEventListener('resize', () => {
      const newVisible = window.innerWidth >= 1024 ? 7 : 1;
      const currentVisible = swiper.params.slidesPerView;
      if (newVisible !== currentVisible) {
        location.reload(); // Reload propre si changement de mode
      }
    });
  </script>
  <script>
  window.addEventListener('DOMContentLoaded', async () => {
    const res = await fetch('/auth/status');
    const status = await res.json();

    if (!status.connected) {
      // utilisateur non connect√© => on affiche le modal de connexion
      loadModalFromURL("/html/sign_in.html");
    }
  });
</script>
</body>

</html>